# ANALISI DI VEGETAZIONE - FORME BIOLOGICHE - RAUNKIAER

# Partiamo dal file matrice_specie_plot_Raunkiaer.csv, che contiene:
  Le specie come righe
  Le forme biologiche associate
  Le abbondanze nei plot, già in formato numerico (Braun-Blanquet convertito)

 # il file `matrice_specie_plot_Raunkiaer.csv`, che contiene:
  Le specie come righe
  Le forme biologiche associate
  Le abbondanze nei plot, già in formato numerico (Braun-Blanquet convertito)

# 1. Caricamento dati
dati_raunkiaer <- read.csv("matrice_specie_plot_Raunkiaer.csv", sep = ";", header = TRUE)

# 2. Librerie
library(dplyr)
library(tidyr)
library(ggplot2)

# 3. Oggetti chiave
rownames(dati_raunkiaer) <- dati_raunkiaer$specie
forme_biologiche <- dati_raunkiaer$forme_biologiche
matrice_abbondanze <- dati_raunkiaer[, -(1:2)]

# 4. Somma abbondanze per forma biologica e plot
matrice_con_forme <- cbind(forma_bio = forme_biologiche, matrice_abbondanze)

abb_per_forma_plot <- matrice_con_forme %>%
  group_by(forma_bio) %>%
  summarise(across(everything(), ~ sum(as.numeric(.), na.rm = TRUE)))

# 5. Prepara dati per boxplot (una sola volta)
abb_perc <- abb_per_forma_plot %>%
  # Escludi colonne non informative (eventuali totali)
  select(-matches("TOT")) %>%
  # Elimina colonne con tutti NA o con nome strano
  select(where(~!all(is.na(.)))) %>%
  select(-matches("^NA_")) %>%
  # Passaggio a formato lungo
  pivot_longer(-forma_bio, names_to = "Plot", values_to = "Abb") %>%
  # Etichetta T0 vs T1
  mutate(Tipo = ifelse(grepl("^S_", Plot), "T0", "T1")) %>%
  group_by(Plot) %>%
  mutate(perc = 100 * Abb / sum(Abb, na.rm = TRUE)) %>%
  ungroup() %>%
  filter(is.finite(perc))

# select(-matches("TOT"))            # elimina S_TOT, R_TOT
# select(where(~!all(is.na(.))))     # elimina colonne piene di NA
# select(-matches("^NA_"))           # elimina colonne con nomi tipo NA_NA.1

# 6. Boxplot finale
# se non l'hai già, installa ggrepel

install.packages("ggrepel")
library(vegan)
library(ggplot2)
library(ggrepel)

# dopo aver calcolato `nmds` e preparato `punti_nmds`

ggplot(punti_nmds, aes(x = MDS1, y = MDS2, color = Tipo)) +
  geom_point(size = 4, alpha = 0.8) +
  stat_ellipse(aes(fill = Tipo), geom = "polygon", alpha = 0.2, color = NA) +
  # qui aggiungiamo le etichette, evitando sovrapposizioni
  geom_text_repel(aes(label = Plot),
                  size = 3,              # dimensione del testo
                  max.overlaps = 20,     # quanti overlap tentare di risolvere
                  box.padding  = 0.3,    # spazio intorno a etichetta
                  point.padding= 0.2) +  # spazio intorno al punto
  scale_color_manual(values = c("T0" = "skyblue", "T1" = "tomato")) +
  labs(title = "Ordination plot (NMDS) – Forme biologiche",
       x = "Dimensione 1 (NMDS1)", 
       y = "Dimensione 2 (NMDS2)") +
  theme_minimal()




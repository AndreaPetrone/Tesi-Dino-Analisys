# 1 – Calcola NMDS

library(vegan)
library(ggplot2)

# La matrice già preparata:
# dati_multivariati contiene: Plot | Tipo | Ch | G | H | P | T
matrice_nmds <- dati_multivariati %>%
  select(-Plot, -Tipo)  # solo abbondanze

# NMDS (2 dimensioni, metodo Bray-Curtis)
set.seed(123)
nmds <- metaMDS(matrice_nmds, distance = "bray", k = 2, trymax = 100)

# Controlla stress
nmds$stress

# Se lo stress < 0.2, la rappresentazione è accettabile. Sotto 0.1 è ottima.
# Lo stress è una misura di quanto bene l’NMDS riesce a rappresentare i dati multivariati in due (o più) dimensioni.
# L’NMDS (Non-Metric Multidimensional Scaling) cerca di posizionare i tuoi plot su un piano (di solito 2D) in modo che la distanza tra i punti rappresenti fedelmente le differenze tra le composizioni di forme biologiche (cioè le distanze di Bray-Curtis).
# Ma ridurre da uno spazio complesso (es. 5 dimensioni) a 2 comporta inevitabilmente una perdita di informazioni. Lo stress misura quanto è grande questa perdita.
# il tuo stress è < 0.1, quindi l’NMDS ha rappresentato bene la struttura dei dati in 2D, con poca distorsione. Le distanze tra i punti nel grafico sono affidabili per interpretare le differenze tra T0 e T1.

# 2 – Prepara dati per ggplot

# Coord. NMDS + Tipo
punti_nmds <- as.data.frame(nmds$points)
punti_nmds$Tipo <- dati_multivariati$Tipo
punti_nmds$Plot <- dati_multivariati$Plot

# 3 – Crea grafico NMDS

ggplot(punti_nmds, aes(x = MDS1, y = MDS2, color = Tipo)) +
  geom_point(size = 4, alpha = 0.8) +
  stat_ellipse(aes(fill = Tipo), geom = "polygon", alpha = 0.2, color = NA) +
  # qui aggiungiamo le etichette, evitando sovrapposizioni
  geom_text_repel(aes(label = Plot),
                  size = 3,              # dimensione del testo
                  max.overlaps = 20,     # quanti overlap tentare di risolvere
                  box.padding  = 0.3,    # spazio intorno a etichetta
                  point.padding= 0.2) +  # spazio intorno al punto
  scale_color_manual(values = c("T0" = "skyblue", "T1" = "tomato")) +
  labs(title = "Ordination plot (NMDS) – Forme biologiche",
       x = "Dimensione 1 (NMDS1)", 
       y = "Dimensione 2 (NMDS2)") +
  theme_minimal()

# spiegazione del grafico:
# Questo grafico rappresenta un'ordinazione NMDS (Non-Metric Multidimensional Scaling) della composizione in forme biologiche nei tuoi plot, nei due tempi `T0` (Survey) e `T1` (Resurvey). Ti spiego passo per passo cosa ci mostra:
# Ogni pallino è un rilievo (plot × tempo), con:
  Colori:
  Azzurro (T0) = survey iniziale
  Rosso (T1) = resurvey (una delle iterazioni combinatorie)
  Etichette: i nomi delle colonne della matrice (es. `S_3.3`, `R_1.1b`).
# Dimensione 1 (NMDS1) e Dimensione 2 (NMDS2) sono le due dimensioni principali lungo cui i rilievi sono proiettati per rappresentare dissimilarità compositive.
# Distanza tra punti: più due rilievi sono vicini, più simili sono nella composizione di forme biologiche. Se due punti sono lontani, le loro comunità floristiche differiscono.
# Ellissi:
  Sono ellissi di confidenza che racchiudono i punti di ciascun gruppo (`T0` e `T1`) e mostrano la variabilità interna.
  Si basano sulle coordinate NMDS → non hanno interpretazione diretta in metri ecologici, ma aiutano a visualizzare il raggruppamento.

# INTERPRETAZIONE
# punti rossi (T1) tendono a essere più concentrati al centro, mentre i blu (T0) sono più dispersi, anche se vi è sovrapposizione evidente.
# Alcuni plot di T0 (es. `S_12`, `S_3.3`) e T1 (es. `R_12c`) sono outlier, ossia lontani dalla nube principale → potrebbero avere una composizione in forme biologiche molto diversa dagli altri.
# L’ampia sovrapposizione delle ellissi indica che le composizioni tra T0 e T1 non sono nettamente distinte, il che coincide con il risultato della PERMANOVA: nessuna differenza statisticamente significativa (p = 0.211).

# CONCLUSIONI
# La NMDS mostra che non c’è separazione netta tra T0 e T1 in termini di forme biologiche → supporta la PERMANOVA.
# Potresti segnalare:
"Lievi differenze nella composizione, ma con forte sovrapposizione."
"Trend di avvicinamento tra alcune forme, ma non statisticamente significativi."
